---
title: "Clase 6"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Tarea 6.
# Metodos supervisados 2

# Estudiante
* Merian Herrera Fuentes
* meryann68@gmail.com
* 207180364

```{r warning=FALSE, echo=FALSE}
library(caret)
library(caTools)
library(class)
library(corrplot)
library(dplyr)
library(e1071)
library(ggplot2)
library(lattice)
library(neuralnet)
library(randomForest)
library(readr)
library(ROCR)
library(rpart)
library(rpart.plot)
```

# 1. Analisis del Problema
 
 Los datos se obtienen mediante el  parte oficial de transito que realiza la Direccion General de Policia de Transito al presentarse un accidente, los cuales ingresan a la base de datos de dos formas (hand held y papel). Debido a que parte de la labor principal de la Institucion es salvar vidas, y por los recursos limitados que existen, se trabaja solo con accidentes con heridos y/o fallecidos; y no se trabaja con accidentes que presentan solo datos materiales. Ademas, posteriormente inicia el proceso de limpieza, correccion de inconsistencias, validacion de algunas variables,  georeferenciacion de los accidentes, entre otros. <br><br>

Accidente con victima se refiere cuando en el accidente de transito al menos uno de los participantes resulto: herido leve, grave o fallecido. <br><br>

Para mas informacion revisar la metodologia del documento Memoria estadistica de accidentes de transito con victimas.Periodo 2012-2014. <br><br>

Fuente del dataset:
http://datosabiertos.csv.go.cr/dashboards/19683/accidentes/

# 2. Cargue el archivo nombre.csv en una variable

```{r}
datos_headers = c("id", "rol", "tipo_de_lesion", "edad", "edad_quinquenal", "sexo", "anno", "mes", "dia", "provincia", "canton", "distrito", "dia_1", "mes_1", "edad_quinquenal_1")

datos <- read.csv("datos-transito.csv", 
                  encoding = "UTF-8", 
                  col.names = datos_headers)

head(datos, 80000)
```


```{r}
datos$asistencia_medica <-  as.factor(with(datos, ifelse(datos$tipo_de_lesion %in% c("Herido leve", "Herido grave", "Muerte"), "si", "no")))

drops <- c("id", "tipo_de_lesion", "edad", "dia_1", "mes_1", "edad_quinquenal_1")
datos <- datos[ , !(names(datos) %in% drops)]

head(datos)
```


# 3. Desarolle el Entendimiento de los Datos

#### Valores nulos

```{r}
sapply(datos, function(x) {sum(is.na(x))})
```

#### Variables

- **Rol: ** Este es el role de la persona que participo en el accidente. Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(rol) %>% 
  summarise(count = n()) 
```

- **Tipo de lesion: ** Tipo de lesion sufrida por la persona que ha tenido el accidente. Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(asistencia_medica) %>% 
  summarise(count = n()) 
```

- **Edad Quinquenal: **

```{r}
datos %>% 
  group_by(edad_quinquenal) %>% 
  summarise(count = n()) 
```

- **Sexo: ** Sexo de la victima del accidente. Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(sexo) %>% 
  summarise(count = n()) 
```

- **Anno: ** Anno en el que sucedio en el accidente. Variable numerica, posibles valores:

```{r}
datos %>% 
  group_by(anno) %>% 
  summarise(count = n()) 
```

- **Mes: ** Mes en el que sucedio el accidente. Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(mes) %>% 
  summarise(count = n()) 
```

- **Dia: ** Dia de la semana en que sucedio el accidente.Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(dia) %>% 
  summarise(count = n()) 
```

- **Provincia: ** Provincia en la que sucedio el accidente. Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(provincia) %>% 
  summarise(count = n()) 
```

- **Canton: ** Canton donde sucedio el accidente.Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(canton) %>% 
  summarise(count = n()) 
```

- **Distrito: ** Distrito donde sucedio el accidente. Variable categorica, posibles valores:

```{r}
datos %>% 
  group_by(distrito) %>% 
  summarise(count = n())
```

```{r}
glimpse(datos)
```

# 4. Utilizando barplot cree un grafico de los atributos del dataset, observe las correlaciones entre atributos

```{r}
provincia_sexo  <- datos %>% 
  group_by(provincia, sexo) %>% 
  summarise(count = n()) 

ggplot(data = provincia_sexo, aes(x = provincia, y = count, fill = sexo)) +
  geom_bar(stat = "identity")
```

```{r}
datos_provincia  <- datos %>% 
  group_by(rol, asistencia_medica) %>% 
  summarise(count = n()) 

ggplot(data = datos_provincia, aes(x = rol, y = count, fill = asistencia_medica)) +
  geom_bar(stat = "identity")
```

```{r}
datos_mes  <- datos %>% 
  group_by(mes, asistencia_medica) %>% 
  summarise(count = n()) 

ggplot(data = datos_mes, aes(x = mes, y = count, fill = asistencia_medica)) +
  geom_bar(stat = "identity")

```

# 5. Realice al menos 5 modelos de los observados en clase

#### Dividir los datos

```{r}
set.seed(12)
split_data <- sample.split(datos$asistencia_medica, SplitRatio = 0.7)

datos_entrenamiento <- datos[split_data,]
datos_prueba <- datos[!split_data,]
```

```{r}
barplot(table(datos_entrenamiento$asistencia_medica), main = 'Distribución de las clases en los Datos de Entrenamiento', ylab = 'Observaciones', xlab = 'Clase')

barplot(table(datos_prueba$asistencia_medica), main = 'Distribución de las clases en los Datos de Prueba', ylab = 'Observaciones', xlab = 'Clase')
```


#### KNN

La funcion **knn()** funciona solo con variables numericas, al tener un dataset de practicamente solo variables categoricas, no podemos correr este modelo con el dataset asignado.

#### SVN

```{r}
modelo_svn <- svm(asistencia_medica ~ sexo + rol + provincia, 
                  data = datos_entrenamiento, 
                  kernel = 'linear',
                  cross = 2, 
                  scale = FALSE)
summary(modelo_svn)
```

#### Red Neuronal

```{r}
matriz_dummies <- model.matrix( 
   ~sexo + rol + provincia + asistencia_medica,
   datos_entrenamiento
)

modelo_red_neuronal <- neuralnet(asistencia_medicasi ~ sexoHombre + sexoHombre + rolConductor + rolMotociclista ,
                                 data = matriz_dummies,
                                 hidden = 4,
                                 rep = 1,
                                 linear.output = T)

plot(modelo_red_neuronal, rep = "best")
```


#### Arbol de Decision

```{r}
modelo_arbol <- rpart(asistencia_medica ~ sexo + rol + provincia, 
                      data = datos_entrenamiento, 
                      method =  'class', 
                      control = rpart.control(cp = 0))

rpart.plot(modelo_arbol,
           shadow.col = "gray", 
           main = "Clasificacion de accidentes. Necesita o no asistencia medica")
```

#### Regresion Logistica

```{r}
modelo_regresion_logistica <- glm(asistencia_medica ~ sexo + rol + provincia,
                                   data = datos_entrenamiento,
                                   family = binomial)

summary(modelo_regresion_logistica)
```

#### Bosques Aleatorios

```{r}
modelo_bosque_aleatorio <- randomForest(asistencia_medica ~ sexo + rol + provincia, 
                                        data = datos_entrenamiento)

modelo_bosque_aleatorio
```


# 6. Evaluacion de los modelos


#### SVN

```{r}

```

#### Red Neuronal

```{r}

```

#### Arbol de Decision

```{r}
predicciones_arbol <- predict(modelo_arbol, 
                              newdata = datos_prueba, 
                              type = 'class')

# Comparar la etiqueta verdadera contra la etiqueta predicha.
comparacion_arbol <- table(predicciones_arbol, datos_prueba$asistencia_medica)
print(comparacion_arbol)

verdaderos_positivos_arbol <- comparacion_arbol[2,2]
verdaderos_negativos_arbol <- comparacion_arbol[1,1]
falsos_positivos_arbol <- comparacion_arbol[1,2]
falsos_negativos_arbol <- comparacion_arbol[2,1]

# VP+VN / Total
exactitud_arbol <- (verdaderos_positivos_arbol + verdaderos_negativos_arbol) / sum(comparacion_arbol)

# VP / total positivos
sensibilidad_arbol <- verdaderos_positivos_arbol / (verdaderos_positivos_arbol + falsos_negativos_arbol)

# VP / Total clasificados positivos
precision_arbol <- verdaderos_positivos_arbol / (verdaderos_positivos_arbol + falsos_positivos_arbol )

# VN/ Total Negativos
especificidad_arbol <- verdaderos_negativos_arbol / (verdaderos_negativos_arbol + falsos_positivos_arbol)

paste("* Exactitud Total del modelo Arbol de decision: ", round(exactitud_arbol * 100, digits = 0), "%")
paste("* Sensibilidad del modelo Arbol de decision: ", round(sensibilidad_arbol * 100, digits = 0), "%")
paste("* Precision del modelo Arbol de decision: ", round(precision_arbol * 100, digits = 0), "%")
paste("* Especificidad del modelo Arbol de decision: ", round(especificidad_arbol * 100, digits = 0), "%")
```

#### Regresion Logistica

```{r}

```

#### Bosques Aleatorios

```{r}

predicciones_bosque_aleatorio <- predict(modelo_bosque_aleatorio, 
                                         newdata = datos_prueba, 
                                         type = 'class')
head(predicciones_bosque_aleatorio, 20)

```




# 7. Desarolle al menos 5 conclusiones sobre las clasificaciones de los modelos



